# AI Agent Instructions for scriptify

## Required Reading for AI Agents

When starting work on this repository, please read the following documents in order:

### 1. Project Overview
- `README.md` - Project description, features, and usage examples
- `CHANGELOG.md` - Recent changes and version history
- `Cargo.toml` - Dependencies and project metadata

### 2. Development Guidelines
- `CONTRIBUTING.md` - Development workflow and contribution guidelines
- `docs/DEVELOPMENT.md` - Detailed development processes and project structure

### 3. Codebase Structure
```
scriptify/
├── src/lib.rs              # Main documentation (README source)
├── src/cmd.rs              # Command execution functionality
├── src/fs.rs               # File system operations
├── src/echo.rs             # Output formatting
├── src/color.rs            # Color definitions
├── src/style.rs            # Style utilities
├── examples/               # Usage examples
└── xtask/                  # Development task runner
```

## Key Development Rules

### Branch-Based Development Workflow

#### MANDATORY: Always Use Feature Branches
- **NEVER WORK DIRECTLY ON MAIN** - All changes must go through feature branches
- **ALWAYS** create a new branch before starting any work
- **REQUIRE** Pull Request review process for all changes
- **PROTECT** main branch from direct commits

#### Starting New Work
1. **Update main branch first:**
   ```bash
   git checkout main
   git pull origin main
   ```

2. **Create feature branch:**
   ```bash
   # Use descriptive branch names with prefixes
   git checkout -b feature/your-feature-name
   git checkout -b fix/bug-description
   git checkout -b docs/documentation-update
   git checkout -b refactor/code-improvement
   git checkout -b test/add-test-coverage
   git checkout -b chore/dependency-update
   ```

#### Branch Naming Convention
- `feature/` - New functionality (e.g., `feature/stderr-piping`)
- `fix/` - Bug fixes (e.g., `fix/clippy-warnings`)
- `docs/` - Documentation updates (e.g., `docs/update-readme`)
- `refactor/` - Code refactoring (e.g., `refactor/pipeline-structure`)
- `test/` - Test additions/fixes (e.g., `test/pipe-mode-coverage`)
- `chore/` - Build process, dependencies (e.g., `chore/update-deps`)

#### Development Process
1. **Create branch**: `git checkout -b feature/name`
2. **Implement**: Make your changes
3. **Test frequently**: `cargo test` during development
3. **Pre-commit checks** (MANDATORY):
   ```bash
   # Option 1: All-in-one command (RECOMMENDED)
   cargo xtask precommit  # Runs test + clippy + fmt automatically
   
   # Option 2: Individual commands
   cargo test
   cargo xtask clippy  # Comprehensive clippy checks
   cargo xtask fmt
   cargo xtask readme  # if src/lib.rs docs changed
   ```
5. **Commit**: Use conventional commit messages
6. **Push branch**: `git push origin feature/name`
7. **Create Pull Request**: For code review

#### Pull Request Creation
**Option 1: GitHub CLI (Preferred if available):**
```bash
# Create PR with title and description
gh pr create --title "Brief description of changes" \
  --body "Detailed description:
- What was changed
- Why it was changed
- How to test it
- Any breaking changes"

# Create draft PR for work in progress
gh pr create --draft --title "WIP: Feature name"

# Check PR status
gh pr status

# View PR details
gh pr view
```

**Option 2: GitHub Web Interface:**
- Push branch to origin
- Visit GitHub repository
- Click "Compare & pull request"
- Fill in title and description
- Request reviews if needed

#### Pull Request Guidelines
- **Title**: Use conventional commit format (feat:, fix:, docs:, etc.)
- **Description**: Include:
  - What changed and why
  - Testing instructions
  - Screenshots/examples if applicable
  - Breaking changes (if any)
- **Size**: Keep PRs focused and reasonably sized
- **Tests**: Ensure all tests pass and new functionality is tested
- **Documentation**: Update docs if public API changes

#### Merge Strategy
- **Prefer "Squash and merge"** for clean main branch history
- **Delete feature branch** after successful merge
- **Never force push** to shared branches
- **Rebase feature branch** if main has moved forward

#### Branch Protection (Repository Settings)
Recommended GitHub branch protection rules for main:
- Require pull request reviews before merging
- Require status checks to pass (CI)
- Require branches to be up to date before merging
- Restrict pushes that create files larger than 100MB
- Do not allow bypassing the above settings

### Documentation Management
- **NEVER edit README.md directly** - it's auto-generated from `src/lib.rs`
- To update README: edit `src/lib.rs` docstring and run `cargo xtask readme`
- Always regenerate README after changing `src/lib.rs` documentation

### Code Quality (MANDATORY)
- **PRE-COMMIT**: Run `cargo xtask ci` before any commits
- **PRE-COMMIT**: Use `cargo xtask fmt` for formatting (required)
- **PRE-COMMIT**: ALL code MUST pass clippy with zero warnings:
  - `cargo xtask clippy` (runs comprehensive checks for all targets, tests, and examples)
- Write comprehensive tests for new functionality
- **ZERO TOLERANCE**: Fix ALL clippy warnings before committing - NO EXCEPTIONS

### Clippy Checking Commands
Essential clippy commands to run:
```bash
# Comprehensive clippy check (RECOMMENDED - includes all targets, tests, examples)
cargo xtask clippy

# Individual checks (if you need granular control)
cargo clippy --all-targets --all-features -- -D warnings
cargo clippy --tests -- -D warnings
cargo clippy --examples -- -D warnings

# Quick check without treating warnings as errors
cargo clippy
```

Common clippy issues to watch for:
- `clippy::write_with_newline` - Use `writeln!()` instead of `write!(_, "\n")`
- `clippy::approx_constant` - Avoid using approximate values of mathematical constants
- `clippy::unwrap_used` - Consider using `?` or proper error handling
- `clippy::expect_used` - Prefer explicit error handling in production code

### Platform Considerations
- Primary platforms: Linux and macOS
- Windows: Limited support with automatic fallbacks
- Use Unix-compatible commands in examples
- Test native pipeline features on Rust 1.87.0+

### Recent Important Changes
- Implemented efficient native pipelines using `std::io::pipe` (Rust 1.87.0+)
- Consolidated `src/cmd/` module structure to single `src/cmd.rs` file
- Added automatic fallback for shell-based pipes on older Rust versions

### Testing Strategy
- All examples should work on Unix systems
- Use `.quiet()` in tests to avoid cluttering output
- Test both native and fallback pipeline implementations
- Performance examples demonstrate streaming efficiency

### Development Workflow
1. **Before starting**: Read relevant documentation
2. **During development**: 
   - Run `cargo test` frequently
   - Check `cargo xtask clippy` regularly
   - Format with `cargo xtask fmt`
3. **Before committing** (MANDATORY - NO EXCEPTIONS):
   ```bash
   # Step 1: Ensure tests pass
   cargo test
   
   # Step 2: Run all pre-commit checks (RECOMMENDED)
   cargo xtask precommit  # Runs test + clippy + fmt automatically
   
   # OR run individual commands:
   # cargo xtask clippy    # Check for all clippy warnings (MUST be clean)
   # cargo xtask fmt       # Format code
   # cargo xtask readme    # If src/lib.rs docs were changed
   
   # Step 4: Commit and push to feature branch
   git add .
   git commit -m "feat: descriptive commit message"
   git push origin feature/branch-name
   
   # Step 5: Create Pull Request (if ready for review)
   gh pr create --title "Brief description" --body "Detailed changes"
   ```
   ⚠️ **DO NOT COMMIT** if any clippy command returns warnings or errors
   ⚠️ **DO NOT PUSH TO MAIN** - Always use feature branches

### Commit Guidelines
- **BRANCH FIRST**: Never commit directly to main - always use feature branches
- Use conventional commit format (feat:, fix:, docs:, refactor:, test:, chore:)
- Test locally with full workflow above before committing
- Update documentation in `src/lib.rs` when adding features
- Separate logical changes into different commits
- **NEVER COMMIT** with clippy warnings or test failures
- **MANDATORY**: Run clippy checks before EVERY commit
- If clippy fails, fix all warnings before proceeding
- **PULL REQUEST REQUIRED**: All changes must go through PR review process

### Pull Request Workflow Example
```bash
# 1. Start new feature
git checkout main && git pull origin main
git checkout -b feature/add-async-support

# 2. Implement changes
# ... make your changes ...

# 3. Pre-commit checks
cargo xtask precommit  # All-in-one: test + clippy + fmt
cargo xtask readme     # If src/lib.rs docs changed

# 4. Commit and push
git add .
git commit -m "feat: add async command execution support"
git push origin feature/add-async-support

# 5. Create PR
gh pr create --title "Add async command execution support" \
  --body "- Implements async versions of run() and output()
- Adds tokio dependency for async runtime
- Includes comprehensive tests for async functionality
- Updates documentation with async examples"

# 6. After PR approval and merge, cleanup
git checkout main
git pull origin main
git branch -d feature/add-async-support
```

## Before Making Changes

1. **MANDATORY**: Create a feature branch:
   ```bash
   git checkout main && git pull origin main
   git checkout -b feature/your-feature-name
   ```
2. Read the specific files relevant to your task
3. Run `cargo test` to ensure current state is working
4. **MANDATORY**: Run `cargo xtask clippy` to check for all lint issues
5. Understand the pipeline implementation (native vs fallback)
6. Check if README regeneration is needed after changes

## After Completing Changes

1. **MANDATORY**: Run full pre-commit checklist
2. Commit changes to feature branch
3. Push feature branch to origin
4. **MANDATORY**: Create Pull Request for review
5. Address any review feedback
6. Merge PR after approval (squash and merge preferred)
7. Delete feature branch and switch back to main

## Common Tasks (All via Feature Branches)

- **Add new command feature**: 
  ```bash
  git checkout -b feature/new-command-feature
  # Modify src/cmd.rs, add tests, update src/lib.rs docs
  # Run pre-commit checks, commit, push, create PR
  ```
- **Add example**: 
  ```bash
  git checkout -b docs/add-example
  # Create in examples/, ensure Unix compatibility
  # Run pre-commit checks, commit, push, create PR
  ```
- **Fix performance**: 
  ```bash
  git checkout -b refactor/improve-performance
  # Focus on pipeline implementation in src/cmd.rs
  # Run pre-commit checks, commit, push, create PR
  ```
- **Update docs**: 
  ```bash
  git checkout -b docs/update-documentation
  # Edit src/lib.rs docstring, run cargo xtask readme
  # Run pre-commit checks, commit, push, create PR
  ```
- **Fix clippy warnings**: 
  ```bash
  git checkout -b fix/clippy-warnings
  # Run cargo xtask clippy to catch all issues
  # Fix all warnings, run pre-commit checks, commit, push, create PR
  ```

### Pre-Commit Checklist (MANDATORY for ALL branches)
**RECOMMENDED: Use all-in-one command:**
- `cargo xtask precommit` (runs test + clippy + fmt automatically)
- `cargo xtask readme` (if src/lib.rs docs changed)

**OR run individual commands:**
1. `cargo test` (ensure all tests pass)
2. `cargo xtask clippy` (comprehensive clippy checks for all targets, tests, and examples)
3. `cargo xtask fmt` (format code)
4. `cargo xtask readme` (if src/lib.rs docs changed)

### Absolute Rules
- **ZERO TOLERANCE POLICY**: Never commit with ANY clippy warnings
- **BLOCKING RULE**: If clippy fails, stop and fix ALL warnings immediately
- **BRANCH RULE**: Never work directly on main branch
- **PR RULE**: All changes must go through Pull Request review
- **CLEAN HISTORY**: Use "Squash and merge" to maintain clean main branch history